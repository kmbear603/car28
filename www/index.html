<!DOCTYPE HTML>
<html>
    <head>
        <title>28car幫手</title>
        <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    </head>
    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-12 col-md-4 col-lg-3">
                    <div class="">
                        <form onSubmit="return false" class="form-horizontal">
                            <div class="form-group">
                                <label class="col-xs-3 control-label">車類</label>
                                <div class="col-xs-9">
                                    <div class="input-group">
                                        <div class="btn-group">
                                            <button id="vehicle-button" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">ANY</button>
                                            <ul id="vehicle-select" class="dropdown-menu"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 control-label">車廠</label>
                                <div class="col-xs-9">
                                    <div class="input-group">
                                        <div class="btn-group">
                                            <button id="maker-button" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">ANY</button>
                                            <ul id="maker-select" class="dropdown-menu"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 control-label">型號</label>
                                <div class="col-xs-9">
                                    <div class="input-group">
                                        <input id="model-input" type="text" class="form-control" value="" />
                                    </div>
                                    <!--<span class="help-block">用逗號分隔, 例: jazz,corolla</span>//-->
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 control-label">座位</label>
                                <div class="col-xs-9">
                                    <div class="input-group">
                                        <div class="btn-group">
                                            <button id="seat-button" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">ANY</button>
                                            <ul id="seat-select" class="dropdown-menu"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 control-label">引擎</label>
                                <div class="col-xs-9">
                                    <div class="input-group">
                                        <input id="min-engine-input" type="text" class="form-control" value="" />
                                        <span class="input-group-addon">-</span>
                                        <input id="max-engine-input" type="text" class="form-control" value="" />
                                        <span class="input-group-addon">cc</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 control-label">傳動</label>
                                <div class="col-xs-9">
                                    <div class="input-group">
                                        <div class="btn-group">
                                            <button id="transmission-button" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">ANY</button>
                                            <ul id="transmission-select" class="dropdown-menu"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 control-label">年份</label>
                                <div class="col-xs-9">
                                    <div class="input-group">
                                        <input id="min-year-input" type="text" class="form-control" value="" />
                                        <span class="input-group-addon">-</span>
                                        <input id="max-year-input" type="text" class="form-control" value="" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 control-label">價格</label>
                                <div class="col-xs-9">
                                    <div class="input-group">
                                        <span class="input-group-addon">$</span>
                                        <input id="min-price-input" type="text" class="form-control" value="" />
                                        <span class="input-group-addon">-</span>
                                        <input id="max-price-input" type="text" class="form-control" value="" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 control-label">狀態</label>
                                <div class="col-xs-9">
                                    <div class="input-group">
                                        <div class="btn-group">
                                            <button id="status-button" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">ANY</button>
                                            <ul id="status-select" class="dropdown-menu"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 control-label">備註</label>
                                <div class="col-xs-9">
                                    <div class="input-group">
                                        <input id="remark-input" type="text" class="form-control" value="" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 control-label">排序</label>
                                <div class="col-xs-9">
                                    <div class="input-group">
                                        <div class="btn-group">
                                            <button id="sort-button" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">UPDTIME</button>
                                            <ul id="sort-select" class="dropdown-menu"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-xs-3"></div>
                                <div class="col-xs-9">
                                    <button type="button" class="btn btn-primary" onClick="onClickSearchButton()">更新</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="col-xs-12 col-md-8 col-lg-9">
                    <div id="result"></div>
                </div>
            </div>
            <div id="image-container" style="display:none; position:absolute; background-color:rgba(0, 0, 0, 0.9); z-index:9999;" onClick="hideImage()">
                <img id="image-view" style="opacity:1; max-width:100%;" />
            </div>
            <br/>
            <br/>
        </div>
        
        <script src="//code.jquery.com/jquery-3.1.1.slim.min.js"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/superagent/3.4.1/superagent.min.js"></script>
        <script type="text/javascript">
            const request = window.superagent;
        
            var CURRENT_SEARCH = {};

            Number.prototype.padLeft = function(base, chr){
                var len = (String(base || 10).length - String(this).length) + 1;
                return len > 0 ? new Array(len).join(chr || '0') + this : this;
            };
            
            function formatNumber(v){
                var s = Math.round(v) + "";
                var dec = s.length;
                
                if (dec > 3){
                    // add the comma
                    var c = dec % 3 > 0 ? dec % 3 : dec % 3 + 3;
                    var t = "";
                    var finished = false;
                    for (var i = 0; i < s.length; i++){
                        const this_char = s.charAt(i);
                        if (this_char == ".")
                            finished = true;
                        else if (!finished && i == c){
                            t += ",";
                            c += 3;
                            dec++;
                        }
                        t += this_char;
                    }
                    s = t;
                }
                
                return s;
            };

            function showImage(src){
                $("#image-view").attr("src", src);
                $("#image-container").show();
            }
            
            function hideImage(){
                $("#image-container").hide();
            }

            function disableForm(){
                $("button").attr("disabled", true);
                $("input").attr("disabled", true);
            }
            
            function enableForm(){
                $("button").removeAttr("disabled");
                $("input").removeAttr("disabled");
            }
        
            function onClickSortButton(name){
                $(".sort-button").removeClass("btn-primary");
                $("#sort-button-" + name).addClass("btn-primary");
            }

            function onClickShowAllDetail(){
                var vid_list = [];
                $(".detail-container").each((i, div)=>{
                    const vid = $(div).attr("vid");
                    const state = $(div).attr("state");
                    if (!state)
                        vid_list.push(vid);
                });
                
                if (vid_list.length > 0){
                    const work = function(i){
                        if (i >= vid_list.length)
                            return;
                        onClickDetailButton(vid_list[i], ()=>{
                            work(i + 1);
                        });
                    };
                    work(0);
                }
            }

            function formatTimeString(str){
                const now = new Date();
                const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);

                const tokens = str.split(' ');
                const time_str = tokens[1];

                const date_tokens = tokens[0].split('/');
                const date = new Date(parseInt(date_tokens[0]), parseInt(date_tokens[1] - 1), parseInt(date_tokens[2]));
                
                var date_str = "";
                if (date.getFullYear() == now.getFullYear() && date.getMonth() == now.getMonth() && date.getDate() == now.getDate())
                    date_str += "今日";
                else if (date.getTime()  == yesterday.getTime())
                    date_str += "昨日";
                else if (date.getFullYear() == now.getFullYear())
                    date_str += date_tokens[1] + "/" + date_tokens[2];
                else
                    date_str = tokens[0];
                    
                return date_str + " " + time_str;
            }

            function renderResult(results){
                const result_container = $("#result");
                result_container.children().remove();

                result_container.append(
                    "<div class='row'>\
                        <div class='col-xs-12'>\
                            <a style='cursor:pointer' onClick='onClickShowAllDetail()'>展開全部</a>\
                        </div>\
                        <br/>\
                        <br/>\
                    </div>"
                );

                const container = $("<div/>");
                result_container.append(container);
                
                const colors = [ "#efefef", "#ffffff" ];
                results.forEach((result, i)=>{
                    container.append(
                        "<div class='row' style='background-color:" + colors[i % colors.length] + "; padding:5px'>\
                            <div class='col-xs-12' style='cursor:pointer; padding:10px' onClick='onClickDetailButton(\"" + result.vid + "\")'>\
                                <div class='row'>\
                                    <div class='col-xs-12 col-sm-6'>\
                                        <strong>\
                                            <div class='row'>\
                                                <div class='col-xs-6'>" + result.maker + " " + result.model + "</div>\
                                                <div class='col-xs-2' style='text-align:right'>" + result.year + "</div>\
                                                <div class='col-xs-4' style='text-align:right'>" + (result.sold ? "<small>已售</small> ": "") + "$" + formatNumber(result.price) + "</strong></div>\
                                            </div>\
                                        </strong>\
                                    </div>\
                                    <div class='col-xs-12 col-sm-4'>\
                                        <small>\
                                            <div class='row' style='text-align:right'>\
                                                <div class='col-xs-4'>" + result.seatCount + " 座位</div>\
                                                <div class='col-xs-4'>" + formatNumber(result.engine) + "cc</div>\
                                                <div class='col-xs-4'>" + result.transmission + "</div>\
                                            </div>\
                                        </small>\
                                    </div>\
                                    <div class='col-xs-12 col-sm-2'>\
                                        <small>\
                                            <div class='row' style='text-align:right'>\
                                                <div class='col-xs-12'>" + formatTimeString(result.time) + "</div>\
                                            </div>\
                                        </small>\
                                    </div>\
                                </div>\
                            </div>\
                            <div class='col-xs-12 detail-container' style='display:none; padding:10px' id='detail-" + result.vid + "' vid='" + result.vid + "'>\
                            </div>\
                        </div>"
                    );
                });

                result_container.append("<br/>");
                
                const button_container = $("<div class='row'/></div>")
                result_container.append(button_container);

                const button_box = "<div style='text-align:left' class='col-xs-4'/>";
                const previous_button = $("<div style='text-align:left' class='col-xs-4'><a style='cursor:pointer' onClick='onClickPreviousPageButton()'>&laquo; 上一頁</a></div>");
                const page_label = $("<div style='text-align:center' class='col-xs-4'>第 " + CURRENT_SEARCH.page + " 頁</div>");
                const next_button = $("<div style='text-align:right' class='col-xs-4'><a style='cursor:pointer' onClick='onClickNextPageButton()'>下一頁 &raquo;</a></div>");
                if (CURRENT_SEARCH.page > 1)
                    button_container.append(previous_button);
                else
                    button_container.append(button_box);
                button_container.append(page_label);
                if (!CURRENT_SEARCH.maxPage || CURRENT_SEARCH.page < CURRENT_SEARCH.maxPage)
                    button_container.append(next_button);
                else
                    button_container.append(button_box);
            }
        
            function onClickDetailButton(vid, callback){
                const remark = $("#remark-input").val().trim();
                
                const container = $("#detail-" + vid);
                if (container.is(":visible"))
                    return container.hide();
                else if (container.attr("state") == "loaded")
                    return container.show();
                else if (container.attr("state") == "loading")
                    return;
                
                container.attr("state", "loading");
                container.children().remove();
                container.append("<p>Loading...</p>");
                container.show();
                
                request.get("/detail/" + vid)
                    .then(res=>{
                        container.children().remove();
                        const json = JSON.parse(res.text);
                        
                        var img = "";
                        if (json.picture){
                            const img_width = Math.min(20, Math.floor(100 / json.picture.length));
                            json.picture.forEach(p=>{
                                //const path = getImagePath(p.big);
                                const path = p.big;
                                //img += "<a href='" + path + "' target='_blank'><img src='" + path + "' style='border:1px solid black; width:" + img_width + "%; min-width:150px; min-height:10px' /></a>"
                                img += "<a style='cursor:pointer' onClick='showImage(\"" + path + "\")'><img src='" + path + "' style='border:1px solid black; width:" + img_width + "%; min-width:150px; min-height:10px' /></a>"
                            });
                        }
                        if (img == "")
                            img = "沒有圖片";
                        container.append(
                            "<div class='row'>\
                                <div class='col-xs-12'>" + img + "</div>\
                            </div>"
                        );
                        container.append(
                            "<div class='row' style='padding:5px 0'>\
                                <div class='col-xs-12'>" + json.remark.replace(remark, "<b>" + remark + "</b>") + "</div>\
                            </div>"
                        );
                        if (json.messages){
                            container.append(
                                "<div class='row'>\
                                    <div class='col-xs-12' style='border-style:solid; border-width:1px; border-color:#cdcdcd; margin:3px'>\
                                        <small>\
                                            <table class='table table-condensed'>\
                                                <tbody>"
                                                    + json.messages.map(m=>{
                                                        return "<tr><td><div style='padding:3px'><strong>" + m.role + " " + m.name + "</strong>&nbsp;&nbsp;&nbsp;&nbsp;" + formatTimeString(m.time) + "<br/>" + m.message + "</div></td></tr>";
                                                    }).join(/*"<tr style='line-height:1px'><td style='height:1px; background:#000000'></td></tr>"*/"")
                                                + "</tbody>\
                                            </table>\
                                        </small>\
                                    </div>\
                                </div>"
                            );
                        }
                        container.append(
                            "<div class='row'>\
                                <div class='col-xs-12'><a href='" + json.url + "' target='_blank'>" + json.url + "</a></div>\
                            </div>"
                        );
                        
                        container.attr("state", "loaded");
                        
                        if (callback)
                            callback();
                    })
                    .catch(err=>{
                        console.error(err);
                        container.attr("state", "");
                        alert("failed to get detail");
                        if (callback)
                            callback();
                    });
            }
        
            function showLoading(){
                disableForm();
                $("#result").children().remove();
                $("#result").append("<p>Loading...</p>");
            }
            
            function onClickNextPageButton(){
                showLoading();
                CURRENT_SEARCH.page++;
                getResult(CURRENT_SEARCH.page);
            }
            
            function onClickPreviousPageButton(){
                showLoading();
                if (CURRENT_SEARCH.page > 0){
                    CURRENT_SEARCH.page--;
                    getResult(CURRENT_SEARCH.page);
                }
            }
        
            function getResult(page, trial){
                page = page || 1;
                trial = trial || 1;
                request.get("/result/" + CURRENT_SEARCH.id + "/" + page)
                    .timeout(30000)
                    .then(res=>{
                        const json = JSON.parse(res.text);
                        if (json.processing)
                            return setTimeout(getResult.bind(null, page, trial + 1), Math.min(10, trial * 5) * 1000);
                            
                        if (json.isLastPage)
                            CURRENT_SEARCH.maxPage = page;
                        renderResult(json.results);
                        enableForm();
                    })
                    .catch(err=>{
                        console.error(err);
                        enableForm();
                    });
            }
        
            function onClickSearchButton(){
                const get_min_max = function(id1, id2, name){
                    const get_value = function(id){
                        const str = $("#" + id).val().trim()
                        return str != "" ? parseInt(str) : null;
                    }
                    
                    const v1 = get_value(id1);
                    if (v1 && (isNaN(v1) || v1 < 0)){
                        alert("wrong " + name + " min");
                        return null;
                    }
                    
                    const v2 = get_value(id2);
                    if (v2 && (isNaN(v2) || v2 < 0)){
                        alert("wrong " + name + " max");
                        return null;
                    }
                    
                    if (v1 && v2 && v1 > v2){
                        alert(name + " min > " + name + " max");
                        return null;
                    }
                    
                    return { min: v1, max: v2 };
                }
                
                const engine = get_min_max("min-engine-input", "max-engine-input", "engine");
                if (!engine)
                    return;

                const price = get_min_max("min-price-input", "max-price-input", "price");
                if (!price)
                    return;

                const year = get_min_max("min-year-input", "max-year-input", "year");
                if (!year)
                    return;

                var req = request.get("/search");
                
                const type = $("#vehicle-button").attr("data");
                if (type != "")
                    req = req.query({ type: type });
                
                const maker = $("#maker-button").attr("data");
                if (maker != "")
                    req = req.query({ maker: maker });
                    
                const model = $("#model-input").val().trim();
                if (model != "")
                    req = req.query({ model: model });
                
                const seat = $("#seat-button").attr("data");
                if (seat != "")
                    req = req.query({ seatMin: parseInt(seat) }).query({ seatMax: parseInt(seat) });
                
                if (year.min)
                    req = req.query({ yearMin: year.min });
                if (year.max)
                    req = req.query({ yearMax: year.max });
                
                if (price.min)
                    req = req.query({ priceMin: price.min });
                if (price.max)
                    req = req.query({ priceMax: price.max });
                    
                if (engine.min)
                    req = req.query({ engineMin: engine.min });
                if (engine.max)
                    req = req.query({ engineMax: engine.max });
                
                const transmission = $("#transmission-button").attr("data");
                if (transmission != "")
                    req = req.query({ transmission: transmission });
                    
                const status = $("#status-button").attr("data");
                if (status != "")
                    req = req.query({ status: status });
                
                const remark = $("#remark-input").val().trim();
                if (remark != ""){
                    req = req.query({ remark: remark });
                    if (model && !maker){
                        alert("如要從備註搜索, 請先選擇車廠");
                        return;
                    }
                }
                    
                const sort = $("#sort-button").attr("data");
                if (sort != "")
                    req = req.query({ sort: sort });

                showLoading();

                req.then(res=>{
                    const json = JSON.parse(res.text);
                    CURRENT_SEARCH = { id: json.id, page: 1 };
                    getResult();
                })
                .catch(err=>{
                    enableForm();
                });
            }
        
            function getImagePath(url){
                return "/picture/" + encodeURIComponent(url);
            }
        
            function onSelectVehicle(id, title){
                $("#vehicle-button").attr("data", id == "" ? "" : title);
                $("#vehicle-button").text(title);
            }
        
            function populateTypeSelect(){
                return new Promise((resolve, reject)=>{
                    request.get("/selectable-vehicle")
                        .then(res=>{
                            const vehicles = JSON.parse(res.text);
                            
                            const ul = $("#vehicle-select");
                            ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectVehicle('', '不限')\">不限</a></li>");
                            
                            vehicles.forEach(v=>{
                                ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectVehicle('" + v.id + "', '" + v.type + "')\">" + v.type + "</a></li>");
                            });
                            
                            onSelectVehicle("", "不限");
                            resolve();
                        })
                        .catch(err=>{
                            console.error("populateTypeSelect", err);
                            reject();
                        });
                });
            }
            
            function onSelectMaker(id, title){
                $("#maker-button").attr("data", id == "" ? "" : title);
                $("#maker-button").text(title);
            }
            
            function populateMakerSelect(){
                return new Promise((resolve, reject)=>{
                    request.get("/selectable-maker")
                        .then(res=>{
                            const makers = JSON.parse(res.text);
                            
                            const ul = $("#maker-select");
                            ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectMaker('', '不限')\">不限</a></li>");
                            
                            makers.forEach(v=>{
                                ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectMaker('" + v.id + "', '" + v.maker + "')\">" + v.maker + "</a></li>");
                            });
                            
                            onSelectMaker("", "不限");
                            resolve();
                        })
                        .catch(err=>{
                            console.error("populateMakerSelect", err);
                            reject();
                        });
                });
            }

            function onSelectSeat(id, count, title){
                $("#seat-button").attr("data", id == "" ? "" : count);
                $("#seat-button").text(title);
            }
            
            function populateSeatSelect(){
                return new Promise((resolve, reject)=>{
                    request.get("/selectable-seat")
                        .then(res=>{
                            const seats = JSON.parse(res.text);
                            
                            const ul = $("#seat-select");
                            ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectSeat('', 0, '不限')\">不限</a></li>");
                            
                            seats.forEach(v=>{
                                ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectSeat('" + v.id + "', " + v.seatCount + ", '" + v.seatCount + " 座位')\">" + v.seatCount + " 座位</a></li>");
                            });
                            
                            onSelectSeat("", 0, "不限");
                            resolve();
                        })
                        .catch(err=>{
                            console.error("populateSeatSelect", err);
                            reject();
                        });
                });
            }
            
            function onSelectTransmission(id, title){
                $("#transmission-button").attr("data", id == "" ? "" : title);
                $("#transmission-button").text(title);
            }
            
            function populateTransmissionSelect(){
                return new Promise((resolve, reject)=>{
                    request.get("/selectable-transmission")
                        .then(res=>{
                            const transmissions = JSON.parse(res.text);
                            
                            const ul = $("#transmission-select");
                            ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectTransmission('', '不限')\">不限</a></li>");
                            
                            transmissions.forEach(v=>{
                                ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectTransmission('" + v.id + "', '" + v.transmission + "')\">" + v.transmission + "</a></li>");
                            });
                            
                            onSelectTransmission("", "不限");
                            resolve();
                        })
                        .catch(err=>{
                            console.error("populateTransmissionSelect", err);
                            reject();
                        });
                });
            }
            
            function onSelectStatus(id, title){
                $("#status-button").attr("data", id == "" ? "" : title);
                $("#status-button").text(title);
            }
            
            function populateStatusSelect(){
                return new Promise((resolve, reject)=>{
                    request.get("/selectable-status")
                        .then(res=>{
                            const statuss = JSON.parse(res.text);
                            
                            const ul = $("#status-select");
                            ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectStatus('', '不限')\">不限</a></li>");
                            
                            statuss.forEach(v=>{
                                ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectStatus('" + v.id + "', '" + v.status + "')\">" + v.status + "</a></li>");
                            });
                            
                            onSelectStatus("", "不限");
                            resolve();
                        })
                        .catch(err=>{
                            console.error("populateStatusSelect", err);
                            reject();
                        });
                });
            }
            
            function onSelectSort(id, title){
                $("#sort-button").attr("data", id == "" ? "" : title);
                $("#sort-button").text(title);
            }
            
            function populateSortSelect(){
                return new Promise((resolve, reject)=>{
                    request.get("/sortable-criteria")
                        .then(res=>{
                            const statuss = JSON.parse(res.text);
                            
                            const ul = $("#sort-select");
                            ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectSort('', '預設')\">預設</a></li>");
                            
                            statuss.forEach(v=>{
                                ul.append("<li><a style=\"cursor:pointer\" onclick=\"onSelectSort('" + v.id + "', '" + v.column + "')\">" + v.column + "</a></li>");
                            });
                            
                            onSelectSort("", "預設");
                            resolve();
                        })
                        .catch(err=>{
                            console.error("populateSortSelect", err);
                            reject();
                        });
                });
            }
        
            function resizeImageView(){
                $("#image-container").offset({
                    left: 0,
                    top: 0
                });
                
                $("#image-container").width($(window).width());
                $("#image-container").height($(document).height());
                
                const width = $("#image-view").width();
                const height = $("#image-view").height();
                $("#image-view").offset({
                    left: ($(window).width() - width) / 2,
                    top: window.pageYOffset + ($(window).height() - height) / 2,
                })
            }

            (function(){
                $("form").hide();

                //$(window).resize(resizeImageView);
                
                $("#image-view").on("load", function(){
                    resizeImageView();
                });
                
                Promise.all([ populateTypeSelect(), populateMakerSelect(), populateSeatSelect(), populateTransmissionSelect(), populateStatusSelect(), populateSortSelect() ])
                    .then(()=>{
                        $("form").show();
                    })
                    .catch(()=>{
                        alert("failed, please reload");
                    });
            })();
        </script>
    </body>
</html>